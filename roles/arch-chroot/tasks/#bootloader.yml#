---

- name: configure initramfs build hooks
  lineinfile:
    path: /etc/mkinitcpio.conf
    regexp: '^HOOKS='
    line: HOOKS="{{ initramfs_hooks | join(' ') }}"

- name: embed LUKS key into initramfs
  lineinfile:
    path: /etc/mkinitcpio.conf
    regexp: '^FILES='
    line: 'FILES=(/{{ luks_key_name }})'

- name: rebuild initramfs
  command: mkinitcpio -p linux

- name: restrict access permissions to initramfs
  file:
    path: "/boot/{{ item }}"
    mode: 0600
  with_items:
    - initramfs-linux.img
    - initramfs-linux-fallback.img

- name: install bootctl bootloader
  command: "bootctl --path=/boot install"
